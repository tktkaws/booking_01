# 会議室予約システム 実装計画

## 1. ゴールとスコープ
- Next.js・Tailwind・Supabase を用いて社内会議室の予約を管理する Web アプリを構築する
- ログインユーザーが 3 種類のビュー（月間・週間・リスト）で予約を作成／閲覧できるようにする
- 平日 9:00〜18:00（15 分単位）の時間帯で重複予約を禁止し、JST を基準に管理する
- 予約の CRUD をモーダルで完結させ、フォームとタイムラインを左右に配置した作成 UI を提供する
- 管理者が部署・ユーザーを管理でき、削除ユーザーの予約は同部署の他ユーザーへ引き継ぐ

## 2. 技術構成と初期セットアップ
- Next.js App Router プロジェクトを生成し、Tailwind CSS を組み込み共通 UI コンポーネント基盤を整える
- Supabase プロジェクトを作成し、Auth（Email/SSO 想定）と Database を設定、環境変数を Next.js に連携
- Supabase JS クライアントを SSR/CSR 双方で使えるようラッパーを作成し、セッション管理を行う
- デザインシステムとして Tailwind のカラーパレットとカスタムユーティリティ（15 分グリッドなど）を整備
- (任意) 開発効率向上のため ESLint/Prettier/Testing Framework（Vitest or Jest）を導入

## 3. データベース設計（Supabase / PostgreSQL）
- `departments` テーブル: `id`, `name`, `description`, `default_color`, `created_at`
- `users` テーブル: `id`, `auth_user_id`, `department_id`, `display_name`, `role(admin|member)`, `color`, `text_color`, `created_at`, `deleted_at`
- `bookings` テーブル: `id`, `title`, `description`, `room_id`, `department_id`, `owner_user_id`, `start_at`, `end_at`, `is_company_wide` (bool), `color_override`, `created_at`, `updated_at`
- (必要に応じて) `rooms` テーブル: `id`, `name`, `capacity`, `location`, `default_color`
- 予約重複防止のために `(room_id, start_at)` のユニーク制約と範囲チェックを設定し、`is_company_wide` 列で全社共有予約を表現
- Supabase Row Level Security を有効化し、部署／権限に応じたアクセス制御ポリシーを定義

## 4. 認証・権限設計
- Supabase Auth を利用したメールリンク or SSO 認証を採用し、初回ログイン時に `users` レコードを作成
- `role` 列で管理者を判定し、管理機能は Server Components 側でミドルウェア認可を実施
- 一般ユーザーは自部署と全社公開予約のみを閲覧・操作できるよう API／RLS を構成
- 退職・異動等に備え `deleted_at` を持たせ論理削除し、関連予約は存続させる

## 5. 画面構成
- 共通レイアウト: ヘッダーにビュー切替タブ、今日へ戻るボタン、ログインユーザーのクイック情報を配置
- サイドバー（またはメニュー）に管理者メニューリンク（部署・ユーザー管理）を配置
- グローバルモーダルコンテナを用意し、どのビューからも予約 CRUD モーダルを呼び出せる構成にする

## 6. カレンダービュー実装
- 月間ビュー: カレンダーライブラリ or 自作で月グリッドを描画し、日セルをクリックしたら予約作成モーダルを開く
- 週間ビュー: 平日 5 日 × 9:00〜18:00(15 分グリッド)のタイムバーを描画し、セルクリックで開始時刻をモーダルへ渡す
- リストビュー: 未来の予約を日付順で一覧表示し、フィルタ（部署・会議室・全社予約）を提供
- 月間・週間ビュー共通で、予約ブロックの色はユーザー設定の背景／文字色を使用しツールチップで詳細表示
- ビュー状態や選択日付は URL パラメータ or Zustand などの state 管理で保持

## 7. 予約フォーム UX
- モーダル左側にフォーム（タイトル、会議室、日付、開始時間セレクト、終了時間 or 所要時間、部署全社フラグ、説明）を配置
- 日付はカレンダー、時間・分セレクトは 15 分刻みのプルダウンにし、営業日以外は選択不可
- モーダル右側に選択日のタイムラインを表示し、既存予約との重なりを視覚化（色分け・ツールチップ）
- 送信前に重複チェック API を呼び、エラー時は該当時間帯をハイライト
- 予約作成・更新後は該当ビューを再検証し、Optimistic UI または SWR リフェッチで反映

## 8. バリデーションとビジネスルール
- サーバー側で開始・終了時刻の 15 分刻みチェック、平日のみ許可、9:00〜18:00 外はバリデーションエラー
- 予約重複は `OVERLAPS` クエリ等で検知し、同部署 or 全社予約とのコンフリクトを禁止
- `is_company_wide` の場合は部署問わず全ユーザーへ表示し、権限により編集可否を制御
- 削除時は論理削除とし、同部署の別ユーザーに `owner_user_id` を引き継ぐ処理をトランザクションで実装
- タイムゾーンは全て JST (`Asia/Tokyo`) で保存・表示し、クライアント側で `dayjs` などを利用

## 9. 管理者メニュー
- 部署管理: 一覧・追加・編集・削除（論理削除）UI と API を用意、部署色のプリセット設定を可能にする
- ユーザー管理: 部署配属、権限変更、色設定、退会処理（同部署への予約引き継ぎ先選択）を行う
- 監査ログ (簡易): 予約更新履歴を `bookings_audit` 等に保存し、管理者向けリストで確認できるよう検討

## 10. カラーとテーマ設定
- ユーザーの `color` と `text_color` を保持し、未設定時は部署 or グローバルデフォルトにフォールバック
- Tailwind のカスタム CSS 変数にユーザー色をバインドし、ライト／ダークモードでも視認性を確保
- モーダル上で色プレビューを即時反映し、WCAG コントラストチェックで文字色の自動提案を行う

## 11. 開発フェーズとタスク整理
1. 環境構築: Next.js プロジェクト作成、Tailwind 設定、Supabase API キー設定
2. DB スキーマ定義: Supabase migration 作成、RLS/ポリシー設定、サンプルデータ投入
3. 認証導線: ログイン／ログアウト、セッション保持、保護ルート設定
4. カレンダービュー土台: 月間・週間・リストビューの骨組みとデータ取得ロジック
5. 予約 CRUD フロー: モーダル、フォーム、バリデーション、重複チェック、API ハンドラ
6. カラー・タイムライン UX: カラーカスタマイズ、タイムライン可視化、JST 対応
7. 管理機能: 部署／ユーザー CRUD UI とバックエンド、予約引き継ぎロジック
8. 最終調整: アクセシビリティ、ローディング状態、E2E/ユニットテスト、デプロイ設定

## 12. テスト戦略
- 単体テスト: 予約バリデーション、時間計算、権限判定ロジックを中心に実施
- 統合テスト: Supabase との予約 CRUD API、重複チェック、引き継ぎ処理をテスト
- E2E テスト: レンダリング、ビュー切替、予約作成フロー、管理機能を Playwright 等で自動化
- 手動確認: 色設定と表示のコントラスト、タイムラインの視認性、モバイル・タブレット表示
- モニタリング: デプロイ後に Supabase ログとフロントのエラートラッキング (Sentry 等) を設定

## 13. 今後の拡張案
- 会議室設備情報・参加者招待・通知メール連携などの機能拡張
- 予約分析ダッシュボードや部署別利用率レポート
- 外部カレンダー（Google/Microsoft）との双方向同期

